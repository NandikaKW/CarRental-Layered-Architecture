package lk.ijse.gdse.carrentalsystem.dao;

import lk.ijse.gdse.carrentalsystem.db.DBConnection;
import lk.ijse.gdse.carrentalsystem.dto.AdminDto;
import lk.ijse.gdse.carrentalsystem.dto.EmployeeDto;
import lk.ijse.gdse.carrentalsystem.entity.Admin;
import lk.ijse.gdse.carrentalsystem.entity.Employee;
import lk.ijse.gdse.carrentalsystem.util.CrudUtil;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;

public class EmployeeDAOImpl implements EmployeeDAO{

    @Override
    public boolean save(Employee employee) throws SQLException, ClassNotFoundException {
        return CrudUtil.execute("INSERT INTO employee VALUES(?,?,?,?,?,?)",
                employee.getEmp_id(), employee.getEmp_name(), employee.getAddress(),
                employee.getJob(), employee.getSalary(), employee.getAdmin_id());
    }

    @Override
    public boolean update(Employee employee) throws SQLException, ClassNotFoundException {
        return CrudUtil.execute("UPDATE employee SET name = ?, address = ?, job_role = ?, salary = ?, admin_id = ? WHERE emp_id = ?",
                employee.getEmp_name(), employee.getAddress(), employee.getJob(),
                employee.getSalary(), employee.getAdmin_id(), employee.getEmp_id());
    }

    @Override
    public boolean delete(String employeeId) throws SQLException, ClassNotFoundException {
        return CrudUtil.execute("DELETE FROM employee WHERE emp_id=?", employeeId);
    }

    @Override
    public Employee search(String employeeId) throws SQLException, ClassNotFoundException {
        ResultSet resultSet = CrudUtil.execute("SELECT * FROM employee WHERE emp_id=?", employeeId);
        if (resultSet.next()) {
            return new Employee(
                    resultSet.getString("emp_id"),
                    resultSet.getString("name"),
                    resultSet.getString("address"),
                    resultSet.getString("job_role"),
                    resultSet.getBigDecimal("salary"),
                    resultSet.getString("admin_id")
            );
        }
        return null;
    }

    @Override
    public ArrayList<Employee> getAll() throws SQLException, ClassNotFoundException {
        String query = "SELECT * FROM employee";
        ArrayList<Employee> employees = new ArrayList<>();
        try (Connection connection = DBConnection.getInstance().getConnection();
             Statement statement = connection.createStatement();
             ResultSet resultSet = statement.executeQuery(query)) {

            while (resultSet.next()) {
                employees.add(new Employee(
                        resultSet.getString("emp_id"),
                        resultSet.getString("name"),
                        resultSet.getString("address"),
                        resultSet.getString("job_role"),
                        resultSet.getBigDecimal("salary"),
                        resultSet.getString("admin_id")
                ));
            }
            return employees;  // returning the correct list
        }
    }


    @Override
    public String getNextId() throws SQLException, ClassNotFoundException {
        ResultSet resultSet = CrudUtil.execute("SELECT emp_id FROM employee ORDER BY emp_id DESC LIMIT 1");
        if (resultSet.next()) {
            String lastID = resultSet.getString("emp_id");
            String substring = lastID.substring(1);
            int id = Integer.parseInt(substring);
            int newId = id + 1;
            return String.format("E%03d", newId);
        }
        return "E001";
    }
}
